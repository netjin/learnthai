{% extends "admin/base_admin.html" %}

{% block title %}{{ '编辑' if conversation else '添加' }}对话 - 管理后台{% endblock %}

{% block content %}
<div class="admin-header">
    <h1>{{ '编辑' if conversation else '添加' }}对话</h1>
    <a href="{{ url_for('admin.conversation_list', scene_id=scene.id) }}" class="btn btn-secondary">返回对话列表</a>
</div>

<div class="admin-content">
    <!-- 对话基本信息表单 -->
    <div class="form-section">
        <h2>基本信息</h2>
        <form method="POST" class="admin-form">
            <div class="form-group">
                <label for="title_chinese">对话标题（中文）*</label>
                <input type="text" id="title_chinese" name="title_chinese"
                    value="{{ conversation.title_chinese if conversation else '' }}" required>
            </div>

            <div class="form-group">
                <label for="title_thai">对话标题（泰语）</label>
                <input type="text" id="title_thai" name="title_thai" class="thai-input"
                    value="{{ conversation.title_thai if conversation else '' }}">
            </div>

            <div class="form-group">
                <label for="situation">情境说明</label>
                <textarea id="situation" name="situation"
                    rows="2">{{ conversation.situation if conversation else '' }}</textarea>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="difficulty_level">难度等级</label>
                    <select id="difficulty_level" name="difficulty_level">
                        {% for i in range(1, 6) %}
                        <option value="{{ i }}" {{ 'selected' if conversation and conversation.difficulty_level==i
                            else '' }}>
                            {{ i }} - {{ '★' * i }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="sort_order">排序</label>
                    <input type="number" id="sort_order" name="sort_order"
                        value="{{ conversation.sort_order if conversation else 999 }}">
                </div>
            </div>

            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" name="is_active" {{ 'checked' if not conversation or conversation.is_active
                        else '' }}>
                    启用
                </label>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary">保存基本信息</button>
            </div>
        </form>
    </div>

    {% if conversation %}
    <!-- 对话句子管理 -->
    <div class="form-section">
        <h2>对话句子</h2>

        {% if lines %}
        <div class="lines-list">
            {% for line in lines %}
            <div class="line-item">
                <div class="line-header">
                    <span class="line-number">第 {{ line.line_order }} 句</span>
                    <span class="speaker-badge">{{ line.speaker_role }}</span>
                </div>
                <div class="line-content">
                    <div class="text-thai">{{ line.text_thai }}</div>
                    <div class="text-chinese">{{ line.text_chinese }}</div>
                    {% if line.pronunciation %}
                    <div class="pronunciation">{{ line.pronunciation }}</div>
                    {% endif %}
                    {% if line.key_words %}
                    <div class="key-words">关键词: {{ line.key_words }}</div>
                    {% endif %}
                </div>
                <div class="line-actions">
                    <button onclick="editLine({{ line.id }})" class="btn btn-sm btn-info">编辑</button>
                    <form method="POST" action="{{ url_for('admin.conversation_line_delete', id=line.id) }}"
                        style="display:inline;" onsubmit="return confirm('确定删除这句对话吗？');">
                        <button type="submit" class="btn btn-sm btn-danger">删除</button>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="empty-hint">暂无对话句子</p>
        {% endif %}

        <button onclick="showAddLineForm()" class="btn btn-primary">添加句子</button>
    </div>

    <!-- 添加/编辑句子的模态框 -->
    <div id="lineModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h3 id="modalTitle">添加对话句子</h3>
            <form id="lineForm" method="POST">
                <div class="form-group">
                    <label for="line_order">顺序*</label>
                    <input type="number" id="line_order" name="line_order" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="speaker_role">说话人（中文）*</label>
                        <input type="text" id="speaker_role" name="speaker_role" required>
                    </div>
                    <div class="form-group">
                        <label for="speaker_role_thai">说话人（泰语）</label>
                        <input type="text" id="speaker_role_thai" name="speaker_role_thai" class="thai-input">
                    </div>
                </div>

                <div class="form-group">
                    <label for="text_thai">泰语文本*</label>
                    <textarea id="text_thai" name="text_thai" class="thai-input" rows="2" required></textarea>
                </div>

                <div class="form-group">
                    <label for="text_chinese">中文翻译*</label>
                    <textarea id="text_chinese" name="text_chinese" rows="2" required></textarea>
                </div>

                <div class="form-group">
                    <label for="pronunciation">发音标注</label>
                    <input type="text" id="pronunciation" name="pronunciation">
                </div>

                <div class="form-group">
                    <label for="key_words">关键词（JSON格式）</label>
                    <input type="text" id="key_words" name="key_words" placeholder='["词1", "词2"]'>
                </div>

                <div class="form-group">
                    <label for="notes">备注</label>
                    <textarea id="notes" name="notes" rows="2"></textarea>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">保存</button>
                    <button type="button" onclick="closeModal()" class="btn btn-secondary">取消</button>
                </div>
            </form>
        </div>
    </div>
    {% endif %}
</div>

<script>
    function showAddLineForm() {
        document.getElementById('modalTitle').textContent = '添加对话句子';
        document.getElementById('lineForm').action = "{{ url_for('admin.conversation_line_add', conversation_id=conversation.id) if conversation else '' }}";
        document.getElementById('lineForm').reset();
        document.getElementById('line_order').value = {{ (lines | length + 1) if lines else 1 }};
        document.getElementById('lineModal').style.display = 'block';
    }

    function editLine(lineId) {
        // 这里可以添加编辑功能，暂时简化
        alert('编辑功能开发中');
    }

    function closeModal() {
        document.getElementById('lineModal').style.display = 'none';
    }

    // 点击模态框外部关闭
    window.onclick = function (event) {
        const modal = document.getElementById('lineModal');
        if (event.target == modal) {
            closeModal();
        }
    }
</script>

<style>
    .form-section {
        background: white;
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
    }

    .form-section h2 {
        margin-top: 0;
        margin-bottom: 1.5rem;
        color: #2c3e50;
    }

    .lines-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .line-item {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 1rem;
        background: #f8f9fa;
    }

    .line-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }

    .line-number {
        font-weight: 600;
        color: #3498db;
    }

    .speaker-badge {
        background: #e3f2fd;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.85rem;
        color: #1976d2;
    }

    .line-content {
        margin-bottom: 0.75rem;
    }

    .text-thai {
        font-family: 'Sarabun', 'Noto Sans Thai', sans-serif;
        font-size: 1.1rem;
        margin-bottom: 0.5rem;
        color: #2c3e50;
    }

    .text-chinese {
        color: #666;
        margin-bottom: 0.25rem;
    }

    .pronunciation {
        color: #7f8c8d;
        font-size: 0.9rem;
        font-style: italic;
    }

    .key-words {
        color: #f39c12;
        font-size: 0.85rem;
        margin-top: 0.5rem;
    }

    .line-actions {
        display: flex;
        gap: 0.5rem;
    }

    .empty-hint {
        color: #999;
        text-align: center;
        padding: 2rem;
    }

    /* 模态框样式 */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.4);
    }

    .modal-content {
        background-color: #fefefe;
        margin: 5% auto;
        padding: 2rem;
        border-radius: 8px;
        width: 90%;
        max-width: 700px;
        max-height: 80vh;
        overflow-y: auto;
    }

    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }

    .close:hover,
    .close:focus {
        color: #000;
    }

    .btn-danger {
        background: #dc3545;
        color: white;
    }

    .btn-danger:hover {
        background: #c82333;
    }
</style>
{% endblock %}